<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title> CS 417 Documents </title>
<link href="../../css/layout.css" rel="stylesheet" type="text/css" />
<link href="../../css/main.css" rel="stylesheet" type="text/css" />
<link href="../../css/print.css" rel="stylesheet" type="text/css" media="print" />
<link href="../../css/main-print.css" rel="stylesheet" type="text/css" media="print" />
<style type="text/css">

#main table.doclist {
	width: 80%;
}
#main .doclist .date, #main .doclist .item {
        vertical-align: baseline; /* for opera */
}
#main .doclist tr {
        vertical-align: baseline;
}
#main .doclist th.item {
        text-align: left;
}
#main .doclist td.item {
        text-align: left;
}
#main a.linksign:link, #main a.linksign:visited, #main a.linksign a:hover {
        text-decoration: none;
}

</style>
</head>
<body id="s_cs">
<div id="wrapper">
<!-- _______________________________________ BANNER _______________________________________ -->
<div id="banner">
  <div id="logo">
  <img src="../../css/images/pk-org-pencil.png" alt="pk.org" name="logo" width="122" height="45"/>
  </div>
  <div id="title"> Distributed Systems </div>
  <ul>
    <li class="separator"><a href="../../about/index.html">About</a></li>
    <li class="separator"><a href="../../about/contact.html">Contact</a></li>
    <li><a href="../../sitemap.html">Site map</a></li>
  </ul>
</div>

<!-- _______________________________________ MAIN NAV _______________________________________ -->
<div id="navbar">
	<ul>
	<li class="homelink"><a href="../../index.html">Home</a></li>
<!--
	<li class="aboutlink"><a href="../../about/index.html">About</a></li>
-->
	<li class="ru"><a href="../../rutgers/index.html">Rutgers</a></li>
	<li class="ru416"><a href="../../416/index.html">Operating Systems [416]</a></li>
	<li class="ru417"><a href="../../417/index.html">Distributed Systems [417]</a></li>
	<li class="cslink"><a href="../../cs/index.html">Computing</a></li>
	<li class="photolink"><a href="../../photo/index.html">Photography</a></li>
<!--
	<li class="funlink"><a href="#">Coming</a></li>
	<li class="funlink"><a href="#">Soon</a></li>
-->
	</ul>
</div>

<div id="subnav">
<p>
You are in: 
<ul>
	<li class="first"> <a href="index.html"> Home </a> 
 	<li> <a href="../index.html"> Computing </a> 
 	<li> <a href="../rpc/index.html"> RPC Tutorial </a> 
</ul>
</p>
</div>
<div id="content-wrapper">
<html>
<div id="main">
<div id="headline">
<h1> Introduction to programming with Sun/ONC RPC: step 6 </h1>
</div>

<table>
<tr> <td> <a href="index.html">Step 1</a></td>
<td> <a href="step2.html">Step 2</a></td>
<td> <a href="step3.html">Step 3</a></td>
<td> <a href="step4.html">Step 4</a></td>
<td> <a href="step5.html">Step 5</a></td>
<td class="inverse"> <a href="step6.html">Step 6</a></td></tr>
</table>

<h2>Step 6. Cleanup </h2>

<p>
Your program is now working.
All it needs now is some cleaning up.
This is a crucial step for any non-throw-away code.
You want to make sure the program is readable and flows well.
It shouldn't have the appearance that you just hacked some code
from a template just to get it working. The overall style should be
consistent between your code and the rpcgen-generated code.
For example:
</p>
<ul>
<li>
I do not add a space before the
opening parenthesis on a function call (e.g. "clnt_destroy(clnt)"
instead of "clnt_destroy (clnt)", so I removed them here.
<li>
A name such as <tt>add_1_arg</tt> is not only unclear but
rather long.  It's as bad as naming the first parameter to
function <tt>f</tt> as <tt>f_arg</tt>. I'm just going to call it <tt>v</tt>
(for value; the code is so short that the meaning is clear and doesn't 
need the verbosity that a more global variable would call for).
<li>
It's important that you exit the program or otherwise ensure that
you <em>do not make any more RPC calls</em> if you received an
error from an RPC call (a return of 0).
<li>
I like having my <i>main</i> function at the top, so I moved
it up and declared the function prototypes above it.
<li>
I moved the call to <em>clnt_destroy</em> to the <em>main</em>
function. This allows one to call <em>add</em> multiple times without
having it destroy the client handle after the first call.
<li>
I created a function called <em>rpc_setup</em> to create the
client handle. It's only a few calls but it makes the main
function cleaner to follow.
<li>
I added <tt>#include &lt;stdio.h&gt;</tt> at the top of the file to
avoid errors of an undefined <i>stdio.h</i> (some systems gripe
more than others).
<li>
I added <tt>#include &lt;stdlib.h&gt;</tt> at the top of the file to
keep the compiler on my mac from giving warnings about the implicit
definition of <em>exit</em>. You may not need this on other systems.
<li>
I removed any comments about this being template code.
</ul>
<p>
The <tt>#ifdef DEBUG</tt> statements
should be removed and the code can be made easier to
read if the <i>main</i> function is moved to the top. Variables can
be renamed more sensibly (<tt>add_1_arg</tt> is a bit crude).
Auto-generated comments should be removed.
</p>
<p>
If we really intended to use the add remote procedure call repeatedly
we would not want to create the handle each time, so it would be
a good idea to create the RPC handle just once.
<p>
Here is the final <a href="files/add_client.c">client code</a>:
</p>
<div class="codeblock-box">
<pre>
/* RPC example: add two numbers */

#include "add.h"

CLIENT *rpc_setup(char *host);
void add(CLIENT *clnt, int a, int b);

int
main(int argc, char *argv[])
{
	CLIENT *clnt;  /* client handle to server */
	char *host;    /* host */
	int a, b;

	if (argc != 4) {
		printf("usage: %s server_host num1 num2\n", argv[0]);
		exit(1);
	}
	host = argv[1];
	if ((a = atoi(argv[2])) == 0 && *argv[2] != '0') {
		fprintf(stderr, "invalid value: %s\n", argv[2]);
		exit(1);
	}
	if ((b = atoi(argv[3])) == 0 && *argv[3] != '0') {
		fprintf(stderr, "invalid value: %s\n", argv[3]);
		exit(1);
	}
	if ((clnt = rpc_setup(host)) == 0)
		exit(1);	/* cannot connect */
	add(clnt, a, b);
	clnt_destroy(clnt);
	exit(0);
}

CLIENT *
rpc_setup(char *host)
{
	CLIENT *clnt = clnt_create(host, ADD_PROG, ADD_VERS, "udp");
	if (clnt == NULL) {
		clnt_pcreateerror(host);
		return 0;
	}
	return clnt;
}

void
add(CLIENT *clnt, int a, int b)
{
	int  *result;
	intpair v;	/* parameter for add */

	v.a = a;
	v.b = b;
	result = add_1(&v, clnt);
	if (result == 0) {
		clnt_perror(clnt, "call failed");
	} else {
		printf("%d\n", *result);
	}
}
</div>
<p>
And the <a href="files/add_server.c">server</a> (with one line of diagnostics
being printed) is:
</p>
<div class="codeblock-box">
/*
 * RPC server code for the remote add function
 */

#include "add.h"

int *
add_1_svc(intpair *argp, struct svc_req *rqstp)
{
	static int  result;

	result = argp-&gt;a + argp-&gt;b;
	printf("add(%d, %d) = %d\n", argp-&gt;a, argp-&gt;b, result);
	return &amp;result;
}
</div>

<p>
Even for a trivially simple program like this
there are several ways to format the output. I opt for
a single number on one line:
</p>
<div class="codeblock">
167
</div>
<p>
the number on a single line rather than something like:
</p>
<div class="codeblock">
result is 167
</div>
<p>
or
</p>
<div class="codeblock">
RPC program
123+44 = 167
</div>
<p>
Question: Why?
</p>

<h2> One last thing </h2>
<p>
Before we're completely done with this, let's create a new makefile.
Unfortunately the automatically-generated one is neither easy to
read nor reliable in its list of dependencies. We'll write
a very explicit one. This is how
our <a href="files/makefile">makefile</a> looks now:
<div class="codeblock-box">
CC = gcc
CFLAGS = -g -DRPC_SVC_FG
RPCGEN_FLAG = -C

all: add_client add_server

# the executables: add_client and add_server

add_client: add_client.o add_clnt.o add_xdr.o
	$(CC) -o add_client add_client.o add_clnt.o add_xdr.o -lnsl

add_server: add_server.o add_svc.o  add_xdr.o
	$(CC) -o add_server add_server.o add_svc.o add_xdr.o -lnsl

# object files for the executables 

add_server.o: add_server.c add.h
	$(CC) $(CFLAGS) -c add_server.c

add_client.o: add_client.c add.h
	$(CC) $(CFLAGS) -c add_client.c

# compile files generated by rpcgen

add_svc.o: add_svc.c add.h
	$(CC) $(CFLAGS) -c add_svc.c

add_clnt.o: add_clnt.c add.h
	$(CC) $(CFLAGS) -c add_clnt.c

add_xdr.o: add_xdr.c add.h
	$(CC) $(CFLAGS) -c add_xdr.c

# add.x produces add.h, add_clnt.c, add_svc.c, and add_xdr.c
# make sure we regenerate them if our interface (add.x) changes

add_clnt.c add_svc.c add_xdr.c add.h:	add.x
	rpcgen $(RPCGEN_FLAG) add.x

clean:
	rm -f add_client add_client.o add_server add_server.o add_clnt.* add_svc.* add.h
</div>

<h3> <a href="step5.html">Back to step 5</a></h3>
</div>
<div id="footer">
<hr/>
<style type="text/css">  
span.codedirection { unicode-bidi:bidi-override; direction: rtl; }  
</style>  

<p> &copy; 2003-2011 Paul Krzyzanowski. All rights reserved.</p>
<p>For questions or comments about this site, contact Paul Krzyzanowski, 
<span class="codedirection">gro.kp@ofnibew</span>
</p>
<p>
The entire contents of this site are protected by copyright under national and international law.
No part of this site may be copied, reproduced, stored in a retrieval system, or transmitted, in any form,
or by any means whether electronic, mechanical or otherwise without the prior written
consent of the copyright holder.
If there is something on this page that you want to use, please let me know.
</p>
<p>
Any opinions expressed on this page do not necessarily reflect the opinions of my employers and may not
even reflect mine own.
</p>
<p> Last updated: January 21, 2011
</p>
<img class="stamp" src="../..//css/images/recycled_pixels_logo.png" alt="recycled pixels" height="80" width="80" />
</div> <!-- footer -->
<div id="tear">
</div>


<div id="sidebar1">
<h1 class="first">Contents </h1>
	<h2> <a href="#distributed_computing">Distributed Computing</a> </h2>
	<h2> <a href="#computer_security">Computer Security</a> </h2>
	<h2> <a href="#tutorials">Tutorials</a> </h2>
	<ul>
	<li> <a href="../rutgers/notes/make/index.html"> Makefiles </a> </li>
	<li> <a href="../rutgers/notes/sockets/index.html"> Sockets </a> </li>
	<li> <a href="../rpc/index.html"> RPC </a> </li>
	</ul>
	<h2> <a href="#miscellany">Miscellany</a> </h2>
	<ul>
	<li> <a href="../misc/Cstyle.pdf"> C programming style </a> </li>
	<li> <a href="../misc/osx-space.html"> Freeing space on OS X </a> </li>
	<li> <a href="../misc/osx-setup.html"> Configuring OS X  </a> </li>
	</ul>
</div>

<div id="sidebar2">
<h1 class="first"> ***** </h1>
<p> Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh </p>
<h2> Duis ultrices dolor sed erat. </h2>
<p>Praesent ultrices, turpis vel feugiat tristique, mauris ligula pellentesque urna, quis interdum est enim mollis sem. </p>
<p> Ellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Praesent orci leo, suscipit vel, pretium eu, viverra at, eros. Morbi cursus. </p>
</div>

</div>
</div>
</body>
</html>
