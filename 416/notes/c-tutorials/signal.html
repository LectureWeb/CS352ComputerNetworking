<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title> CS 416 Documents </title>
<link href="../../../css/layout.css" rel="stylesheet" type="text/css" />
<link href="../../../css/main.css" rel="stylesheet" type="text/css" />
<link href="../../../css/print.css" rel="stylesheet" type="text/css" media="print" />
<link href="../../../css/main-print.css" rel="stylesheet" type="text/css" media="print" />
<style type="text/css">

#main table.doclist {
	width: 80%;
}
#main .doclist .date, #main .doclist .item {
        vertical-align: baseline; /* for opera */
}
#main .doclist tr {
        vertical-align: baseline;
}
#main .doclist th.item {
        text-align: left;
}
#main .doclist td.item {
        text-align: left;
}
#main a.linksign:link, #main a.linksign:visited, #main a.linksign a:hover {
        text-decoration: none;
}

</style>
</head>
<body id="s_ru416">
<div id="wrapper">
<!-- _______________________________________ BANNER _______________________________________ -->
<div id="banner">
  <div id="logo">
  <img src="../../../css/images/pk-org-pencil.png" alt="pk.org" name="logo" width="122" height="45"/>
  </div>
  <div id="title"> Operating Systems </div>
  <div id="search">
  <form method="get" action="http://www.google.com/search">
	<div style="border:none ;padding:2px;width:25em;">
	<input type="text" name="q" size="25" maxlength="255" value="" />
	<input type="submit" value="Search" />
	<input type="hidden"  name="sitesearch" value="www.pk.org" checked />
	</div>
  </form>
  </div>
  <ul>
    <li class="separator"><a href="../../../about/index.html">About</a></li>
    <li class="separator"><a href="../../../about/contact.html">Contact</a></li>
    <li><a href="../../../sitemap.html">Site map</a></li>
  </ul>
</div>

<!-- _______________________________________ MAIN NAV _______________________________________ -->
<div id="navbar">
	<ul>
	<li class="homelink"><a href="../../../index.html">Home</a></li>
<!--
	<li class="aboutlink"><a href="../../../about/index.html">About</a></li>
-->
	<li class="ru"><a href="../../../rutgers/index.html">Rutgers</a></li>
	<li class="ru352"><a href="../../../352/index.html">Internet Technology [352]</a></li>
	<li class="ru416"><a href="../../../416/index.html">Operating Systems [416]</a></li>
	<li class="ru417"><a href="../../../417/index.html">Distributed Systems [417]</a></li>
	<li class="ru419"><a href="../../../419/index.html">Computer Security [419]</a></li>
	<li class="cslink"><a href="../../../cs/index.html">Computing</a></li>
	<li class="photolink"><a href="../../../photo/index.html">Photography</a></li>
<!--
	<li class="funlink"><a href="#">Coming</a></li>
	<li class="funlink"><a href="#">Soon</a></li>
-->
	</ul>
</div>

<div id="subnav">
<p>
You are in: 
</p>
<ul>
	<li class="first"> <a href="index.html"> Home </a> 
 	<li> <a href="../../../rutgers/index.html"> Rutgers </a> 
 	<li> <a href="../../index.html"> CS 416 </a> 
 	<li> <a href="../../notes/index.html"> Documents </a> 
 	<li> <a href="../../notes/c-tutorials/index.html"> Tutorials </a> 
 	<li> <a href="../../notes/c-tutorials/signal.html"> Signal Tutorial </a> 
</ul>
</div>
<div id="content-wrapper">
<div id="main">
<div id="headline">
<h1> C Tutorial: Playing with processes </h1>
</div>

<h1> Catching signals </h1>
<p>
Signals are a mechanim in Unix to alert, or poke, a process when one of several events happen.
In some cases, these signals are generated to kill a program (SIGKILL) or notify the program 
that an illegal instruction, illegal memory access, invalid system call, or floating point exception took place.
Other signals can be user-defined (SIGUSR1,
SIGUSR2). When dealing with creating processes, the "child status has changed" signal, SIGCHLD, will
be of interest to us. Take a look at the manual page for signal on your system (<tt>man signal</tt>) to see
the full spectrum of signals that is available &mdash; they differ somewhat from system to system.
</p>
<p>
The program will usually exit upon receipt of a signal but it is possible to use the 
<em>signal</em> function to keep that from happening and either transfer control to a user-specified function
when a specific signal is received or to ignore the signal. 
</p>

<p>
We'll go through a few brief examples of using signals
</p>

<h2> Example 1: catching your own memory access errors  </h2>
<p>
Here's a tiny program that does nothing but read memory location 0, which is an
invalid memory location for user processes. This is the same as the classic bug of
dereferencing a null pointer, which generally causes the shell to show you a
<tt>Segmentation fault</tt> error message. Compile and run this program just
to remind yourself of what happens.
</p>

<div class="codeblock-box"><span class="comment">/* an example that dereferences a null pointer */</span>
<span class="comment">/* Paul Krzyzanowski */</span>

int
main(int argc, char **argv) {
	int a;

	a = *(int *)0;	<span class="comment">/* read address 0 */</span>
}
 </div>
<p>
<a href="files/no-signal1.c">Download this file</a>
</p>
<p> Save this file by control-clicking or right clicking the download link and then saving it as <tt>no-signal1.c</tt>.  </p>
<p> Compile this program via: </p>
<div class="codeblock">
gcc -o no-signal1 no-signal1.c
</div>
<p> If you don't have gcc, You may need to substitute the gcc command with cc or another name of your compiler.  </p>
<p> Run the program: </p>
<div class="codeblock">
./no-signal1
</div>
<p>
Now let's add a signal handler to trap the signal. In this case, the signal of interest
is <tt>SIGSEGV</tt> &ndash; segmentation violation. See <tt>man signal</tt> for the full list of signals.
We create a function called <em>catch</em> that will simply print a message and exit.
To tell the operating system that it should transfer control to <em>catch</em> when the
<tt>SIGSEGV</tt> signal is received, we add a call to:
</p>
<div class="codeblock">
signal(SIGSEGV, catch);	</div>
<p>
This call to <em>signal</em> should, of course, be made early on in the code before we
anticipate getting the event. The function <em>catch</em> gets passed a parameter that
contains the signal number. You can call <em>signal</em> multiple times to have different
signals call the same function (or different functions). Try this code.
</p>
<div class="codeblock-box"><span class="comment">/* signal example #1: trap an illegal address reference */</span>
<span class="comment">/* Paul Krzyzanowski */</span>

#include &lt;stdio.h&gt;	<span class="comment">/* for printf */</span>
#include &lt;stdlib.h&gt;	<span class="comment">/* for exit */</span>
#include &lt;signal.h&gt;	<span class="comment">/* defines signals and the signal() function */</span>

int
main(int argc, char **argv) {
	void catch(int);
	int a;

	signal(SIGSEGV, catch);	<span class="comment">/* catch SIGSEGV - segmentation violation */</span>
	a = *(int *)0;	<span class="comment">/* read address 0 */</span>
}

void
catch(int snum) {
	printf("got signal %d\n", snum);
	exit(0);
}
 </div>
<p> <a href="files/signal1.c">Download this file</a> </p>
<p> Save this file as <tt>signal1.c</tt>.  </p>
<p> Compile this program via: </p>
<div class="codeblock">
gcc -o signal1 signal1.c
</div>
<p> Run the program: </p>
<div class="codeblock">
./signal1
</div>

<h2> Example 2: Sending a signal to a process  </h2>
<p>
Our next example involves sending an external signal to a process that's
happily running and minding its own business.
We will send it <tt>SIGUSR1</tt>, which is a user-defined signal via the
<em>kill</em> command. The <em>kill</em> command is generally used to kill 
a process, and it does so by sending it a <tt>SIGTERM</tt> &ndash; the
signal to terminate a process. That's just the default behavior and you
can use the command to send other signals via the <tt>-s</tt> option. To
send the <tt>SIGUSR1</tt> signal, you would simply run:
</p>
<div class="codeblock">
kill -s USR1 <em>process_id</em>
</div>
<p>
If you were programming this, you would code:
</p>
<div class="codeblock">
kill(SIGUSR1, <em>process_id</em>)
</div>
<p class="nospace">
Here, the main function does three things:
</p>
<ol>
<li> It calls <em>signal</em> to tell the operating system to call the function <em>catch</em> if the 
process receives a <tt>SIGUSR1</tt> signal. </li>
<li> It prints a message with its own process ID number to tell the user how to send the <em>kill</em> command.</li>
<li> It then goes to a loop where it continually goes to sleep for one hour (3600 seconds) </li>
</ol>
<p>
Without receiving a signal, the program is essentially sleeping forever.
When you run the program and send it a <tt>SIGUSR1</tt> signal via the <em>kill</em> command, however,
the <em>catch</em> function is caught and prints a message. It then returns, which causes the program
to go back to its endless for() loop. 
</p>

<div class="codeblock-box"><span class="comment">/* signal example 2: catch an external signal */</span>
<span class="comment">/* Paul Krzyzanowski */</span>

#include &lt;stdio.h&gt;
#include &lt;signal.h&gt;
#include &lt;sys/wait.h&gt;

int
main(int argc, char **argv) {
	void catch(int);
	int waitstat;

	signal(SIGUSR1, catch);
	printf("Run this in another window: kill -s USR1 %d\n", getpid());
	for (;;) {
		printf("Going to sleep\n");
		sleep(3600);	<span class="comment">/* for a good long time */</span>
	}
}

void
catch(int snum) {
	printf("got signal %d\n", snum);
	<span class="comment">/* on SunOS systems, we have to  reset the signal catcher */</span>
	signal(SIGUSR1, catch);	<span class="comment">/* don't need this on Linux or OS X (but doesn't hurt) */</span>
}
 </div>
<p> <a href="files/signal2.c">Download this file</a> </p>
<p> Save it as <tt>signal2.c</tt> and compile it program via: </p>
<div class="codeblock">
gcc -o signal2 signal2.c
</div>
<p> Run the program: </p>
<div class="codeblock">
./signal2
</div>
<p>
On Linux and Mac OS X systems, it is sufficient to have the <em>catch</em> function
simply call the <em>printf</em> function and do nothing else. On SunOS systems, the 
signal has to be reset whenever it is caught, so you need to add the extra call to 
<em>signal</em>.
</p>

<h2> Example 3: detecting the termination of a child process </h2>
<p>
A parent process receives a <tt>SIGCHLD</tt> signal whenever the child process terminates.
This allows a parent process to go off and do other things but still track
the status of its child processes. What we do to accomplish this is set up a signal 
handler that gets called whenever the process gets a <tt>SIGCHLD</tt> signal and have
that signal handler call <em>wait</em>. Normally, <em>wait</em> puts the process to
sleep but in this case we already have that outstanding signal so <em>wait</em> 
simply picks up the status of a child and returns immediately. Calling <em>wait</em>
on child processes is good programming practice since it ensures that the child process 
does not remain a zombie, which is a process that has terminated but is still taking up
space in the process table on the chance that a parent process will need to call
<em>wait</em> to get its exit status.
</p>

<p>
In this sample program, we essentially copy the example we used for <a href="wait.html">
wait</a> but now, instead of waiting for the child to die, the parent sleeps for 10 seconds
and then exits. In reality, of course, you will probably have the parent do useful work,
such as getting and processing input from a user or doing other task.
</p>
<p>
The child prints a message annoucing itself, sleeps for three seconds, and then annouces that
it's exiting. The parent process gets the <tt>SIGCHLD</tt> signal when the child process
exits, which causes the <em>catch</em> function to be called. This function prints a message
that it detected the death of a child and prints its exit status. It then returns, at
which point the parent exits. Note that the parent's <em>sleep</em> was interrupted.
</p>

<div class="codeblock-box"><span class="comment">/* signal3: parent creates a child and detects its termination with a signal */</span>
<span class="comment">/*  The child prints an "I'm the child message and exits after 3 seconds */</span>
<span class="comment">/* Paul Krzyzanowski */</span>

#include &lt;stdlib.h&gt;	<span class="comment">/* needed to define exit() */</span>
#include &lt;unistd.h&gt;	<span class="comment">/* needed for fork() and getpid() */</span>
#include &lt;signal.h&gt;	<span class="comment">/* needed for signal */</span>
#include &lt;stdio.h&gt;	<span class="comment">/* needed for printf() */</span>

int
main(int argc, char **argv) {
	void catch(int);	<span class="comment">/* signal handler */</span>
	void child(void);	<span class="comment">/* the child calls this */</span>
	void parent(int pid);	<span class="comment">/* the parent calls this */</span>
	int pid;	<span class="comment">/* process ID */</span>

	signal(SIGCHLD, catch);	<span class="comment">/* detect child termination */</span>

	switch (pid = fork()) {
	case 0:		<span class="comment">/* a fork returns 0 to the child */</span>
		child();
		break;

	default:	<span class="comment">/* a fork returns a pid to the parent */</span>
		parent(pid);
		break;

	case -1:	<span class="comment">/* something went wrong */</span>
		perror("fork");
		exit(1);
	}
	exit(0);
}

void
child(void) {
	printf("        child: I'm the child\n");
	sleep(3);	<span class="comment">/* do nothing for 3 seconds */</span>
	printf("        child: I'm exiting\n");
	exit(123);	<span class="comment">/* exit with a return code of 123 */</span>
}

void
parent(int pid) {
	printf("parent: I'm the parent\n");
	sleep(10);	<span class="comment">/* do nothing for five seconds */</span>
	printf("parent: exiting\n");
}

void
catch(int snum) {
	int pid;
	int status;

	pid = wait(&amp;status);
	printf("parent: child process exited with value %d\n", WEXITSTATUS(status));
}
 </div>
<p> <a href="files/signal3.c">Download this file</a> </p>
<p> Save it as <tt>signal3.c</tt> and compile it program via: </p>
<div class="codeblock">
gcc -o signal3 signal3.c
</div>
<p> Run the program: </p>
<div class="codeblock">
./signal3
</div>

<h2> Example 4: detecting the termination of multiple child processes  </h2>
<p>
Our final example is a small variation of the previous one. Instead of forking off one child,
the parent will fork off four processes (or change NUMPROCS to whatever you want).
As soon as the parent forks off a child, it loops back to create another one until
it has created NUMPROCS of them. When a process is created, the variable <tt>nprocs</tt>
is incremented to count the number of processes that we forked.
</p>
<p>
The parent then goes into a sleep loop:
</p>
<div class="codeblock">
while (nprocs != 0) {
	printf("parent: sleeping\n");
	sleep(60);      /* do nothing for a minute */
}
</div>
<p class="nospace">
This looks like it will loop forever but two additional things are happening:
</p>
<ol>
<li> Whenever the parent gets the <tt>SIGCHLD</tt> signal and the <em>catch</em> funciton is called,
the call to <em>sleep</em> is interrupted, so that <em>sleep</em> immediately returns. /li>
<li> The signal handler, <em>catch</em>, decrements the count of child processes, <tt>nprocs</tt>, whenever 
it is called.</li>
</ol>

<div class="codeblock-box"><span class="comment">/* signal4: parent creates multiple child processes and detects
   their termination via a signal 
   Each child prints an "I'm the child" message and exits after n seconds,
   where n is the sequence in which it was forked. 

   Paul Krzyzanowski
*/</span>

#include &lt;stdlib.h&gt;	<span class="comment">/* needed to define exit() */</span>
#include &lt;unistd.h&gt;	<span class="comment">/* needed for fork() and getpid() */</span>
#include &lt;signal.h&gt;	<span class="comment">/* needed for signal */</span>
#include &lt;stdio.h&gt;	<span class="comment">/* needed for printf() */</span>

#define NUMPROCS 4	<span class="comment">/* number of processes to fork */</span>
int nprocs;		<span class="comment">/* number of child processes */</span>

int
main(int argc, char **argv) {
	void catch(int);	<span class="comment">/* signal handler */</span>
	void child(int n);	<span class="comment">/* the child calls this */</span>
	void parent(int pid);	<span class="comment">/* the parent calls this */</span>
	int pid;	<span class="comment">/* process ID */</span>
	int i;

	signal(SIGCHLD, catch);	<span class="comment">/* detect child termination */</span>

	for (i=0; i &lt; NUMPROCS; i++) {
		switch (pid = fork()) {
		case 0:		<span class="comment">/* a fork returns 0 to the child */</span>
			child(i);	<span class="comment">/* child() never returns; the function exits */</span>
			break;
		case -1:	<span class="comment">/* something went wrong */</span>
			perror("fork");
			exit(1);
		default:	<span class="comment">/* parent just loops to create more kids */</span>
			nprocs++;	<span class="comment">/* count # of processes that we forked */</span>
			break;
		}
	}
	printf("parent: going to sleep\n");

	<span class="comment">/* do nothing forever; remember that a signal wakes us out of sleeep */</span>
	while (nprocs != 0) {
		printf("parent: sleeping\n");
		sleep(60);	<span class="comment">/* do nothing for a minute */</span>
	}
	printf("parent: exiting\n");
	exit(0);
}

void
child(int n) {
	printf("\tchild[%d]: child pid=%d, sleeping for %d seconds\n", n, getpid(), n);
	sleep(n);	<span class="comment">/* do nothing for n seconds */</span>
	printf("\tchild[%d]: I'm exiting\n", n);
	exit(100+n);	<span class="comment">/* exit with a return code of 100+n */</span>
}

void
catch(int snum) {
	int pid;
	int status;

	pid = wait(&amp;status);
	printf("parent: child process pid=%d exited with value %d\n",
		pid, WEXITSTATUS(status));
	nprocs--;
	signal(SIGCHLD, catch);	<span class="comment">/* reset the siganl (for SunOS) */</span>
}
 </div>
<p> <a href="files/signal4.c">Download this file</a> </p>
<p> Save it as <tt>signal4.c</tt> and compile it program via: </p>
<div class="codeblock">
gcc -o signal4 signal4.c
</div>
<p> Run the program: </p>
<div class="codeblock">
./signal4
</div>


<p>
Note: the <em>signal</em> system call has been replaced with a more robust version, called <em>sigaction</em>.
If you plan on doing extensive programming using signals, be sure to read up on this. The <em>signal</em>
that we're using is really a library wrapper over <em>sigaction</em>
</p>
</div>
<div id="footer">
<hr/>
<style type="text/css">  
span.codedirection { unicode-bidi:bidi-override; direction: rtl; }  
</style>  

<p> &copy; 2003-2019 Paul Krzyzanowski. All rights reserved.</p>
<p>For questions or comments about this site, contact Paul Krzyzanowski, 
<span class="codedirection">gro.kp@ofnibew</span>
</p>
<p>
The entire contents of this site are protected by copyright under national and international law.
No part of this site may be copied, reproduced, stored in a retrieval system, or transmitted, in any form,
or by any means whether electronic, mechanical or otherwise without the prior written
consent of the copyright holder.
If there is something on this page that you want to use, please let me know.
</p>
<p>
Any opinions expressed on this page do not necessarily reflect the opinions of my employers and may not
even reflect my own.
</p>
<p> Last updated: March 28, 2019
</p>
<img class="stamp" src="../../..//css/images/recycled_pixels_logo.png" alt="recycled pixels" height="80" width="80" />
</div> <!-- footer -->
<div id="tear">
</div>


<div id="sidebar1">
<h1 class="first">Contents </h1>
	<h2> CS 416 </h2>
	<ul>
	<li> <a href="../../index.html"> Main course page </a> </li>
	<li> <a href="../../news.html"> News </a> </li>
	<li> <a href="../../syllabus.html"> Syllabus </a> </li>
	<li> <a href="../../hw/index.html"> Homework </a> </li>
	<li> <a href="../../notes/index.html"> Documents </a> </li>
	<li> <a href="../../exam/index.html"> Exam info </a> </li>
	<li> <a href="../../grades/index.html"> Check your grades </a> </li>
	<li> <a href="https://sakai.rutgers.edu/portal"> Sakai </a> </li>
	</ul>

        <h2> Tutorials </h2>
        <ul>
        <li> <a href="../../notes/c-tutorials/index.html"> C/Unix tutorials </a> </li>
        <li> <a href="../../notes/make/index.html"> Makefile tutorial </a> </li>
        <li> <a href="../../notes/sockets/index.html"> TCP/IP Sockets </a> </li>
        <li> <a href="../../notes/rpc/index.html"> ONC RPC tutorial </a> </li>
<!--
        <li> <a href="../../notes/clocks/index.html"> Clocks demo </a> </li>
-->
        </ul>

	
        <h2> <a href="index.html">C Tutorials</a> </h2>
	<h3> Processes </h3>
        <ul>
        <li> <a href="../../notes/c-tutorials/getpid.html"> getpid </a> </li>
        <li> <a href="../../notes/c-tutorials/getppid.html"> getppid </a> </li>
        <li> <a href="../../notes/c-tutorials/fork.html"> fork </a> </li>
        <li> <a href="../../notes/c-tutorials/exec.html"> exec </a> </li>
        <li> <a href="../../notes/c-tutorials/forkexec.html"> fork&amp;exec </a> </li>
        <li> <a href="../../notes/c-tutorials/wait.html"> wait </a> </li>
        <li> <a href="../../notes/c-tutorials/signal.html"> signal </a> </li>
	</ul>
	<h3> I/O and IPC </h3>
	<ul>
        <li> <a href="../../notes/c-tutorials/dup2.html"> dup2 </a> </li>
        <li> <a href="../../notes/c-tutorials/pipe.html"> pipe and dup2 </a> </li>
        <li> <a href="../../notes/c-tutorials/isatty.html"> isatty </a> </li>
	<ul>
	</ul>
	<h3> Timing </h3>
        <li> <a href="../../notes/c-tutorials/times.html"> times </a> </li>
        <li> <a href="../../notes/c-tutorials/gettime.html"> clock_gettime </a> </li>
	<ul>
	<h3> Basics </h3>
	<ul>
        <li> <a href="../../notes/c-tutorials/getopt.html"> Command options </a> </li>
        <li> <a href="../../notes/c-tutorials/strtok.html"> Parsing tokens </a> </li>
<!--
        <li> <a href="../../notes/c-tutorials/fpointer.html"> Pointers to functions </a> </li>
-->
        <li> <a href="../../notes/c-tutorials/list.html"> Linked list </a> </li>
<!--
        <li> <a href="../../notes/c-tutorials/hash.html"> Hash tables </a> </li>
-->
        </ul>

</div>

<div id="sidebar2">
<h1 class="first"> Recommended </h1>
<p>
</p>
<p>
<a href="http://www.amazon.com/exec/obidos/ASIN/020161586X/pkorg/">
<img align="left" width="100" height="138" src="images/practice-of-programming.jpg"
alt="The Practice of Programming"/>
</a>
</p>
<p>
&nbsp;
</p>

<p>
<a href="http://www.amazon.com/exec/obidos/ASIN/0131103628/pkorg/">
<img align="left" width="100" height="132" src="images/c-programming-language.jpg"
alt="The C Programming Language"/>
</a>
</p>
<p>
&nbsp;
</p>

<p>
<a href="http://www.amazon.com/dp/013937681X/pkorg/">
<img align="left" width="100" height="132" src="images/unix-programming-environment.jpg"
alt="The UNIX Programming Environment"/>
</a>
</p>
</div>

</div>
</div>
</body>
</html>
