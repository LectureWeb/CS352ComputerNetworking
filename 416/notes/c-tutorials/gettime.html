<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title> CS 416 Documents </title>
<link href="../../../css/layout.css" rel="stylesheet" type="text/css" />
<link href="../../../css/main.css" rel="stylesheet" type="text/css" />
<link href="../../../css/print.css" rel="stylesheet" type="text/css" media="print" />
<link href="../../../css/main-print.css" rel="stylesheet" type="text/css" media="print" />
<style type="text/css">

#main table.doclist {
	width: 80%;
}
#main .doclist .date, #main .doclist .item {
        vertical-align: baseline; /* for opera */
}
#main .doclist tr {
        vertical-align: baseline;
}
#main .doclist th.item {
        text-align: left;
}
#main .doclist td.item {
        text-align: left;
}
#main a.linksign:link, #main a.linksign:visited, #main a.linksign a:hover {
        text-decoration: none;
}

</style>
</head>
<body id="s_ru416">
<div id="wrapper">
<!-- _______________________________________ BANNER _______________________________________ -->
<div id="banner">
  <div id="logo">
  <img src="../../../css/images/pk-org-pencil.png" alt="pk.org" name="logo" width="122" height="45"/>
  </div>
  <div id="title"> Operating Systems </div>
  <div id="search">
  <form method="get" action="http://www.google.com/search">
	<div style="border:none ;padding:2px;width:25em;">
	<input type="text" name="q" size="25" maxlength="255" value="" />
	<input type="submit" value="Search" />
	<input type="hidden"  name="sitesearch" value="www.pk.org" checked />
	</div>
  </form>
  </div>
  <ul>
    <li class="separator"><a href="../../../about/index.html">About</a></li>
    <li class="separator"><a href="../../../about/contact.html">Contact</a></li>
    <li><a href="../../../sitemap.html">Site map</a></li>
  </ul>
</div>

<!-- _______________________________________ MAIN NAV _______________________________________ -->
<div id="navbar">
	<ul>
	<li class="homelink"><a href="../../../index.html">Home</a></li>
<!--
	<li class="aboutlink"><a href="../../../about/index.html">About</a></li>
-->
	<li class="ru"><a href="../../../rutgers/index.html">Rutgers</a></li>
	<li class="ru352"><a href="../../../352/index.html">Internet Technology [352]</a></li>
	<li class="ru416"><a href="../../../416/index.html">Operating Systems [416]</a></li>
	<li class="ru417"><a href="../../../417/index.html">Distributed Systems [417]</a></li>
	<li class="ru419"><a href="../../../419/index.html">Computer Security [419]</a></li>
	<li class="cslink"><a href="../../../cs/index.html">Computing</a></li>
	<li class="photolink"><a href="../../../photo/index.html">Photography</a></li>
<!--
	<li class="funlink"><a href="#">Coming</a></li>
	<li class="funlink"><a href="#">Soon</a></li>
-->
	</ul>
</div>

<div id="subnav">
<p>
You are in: 
</p>
<ul>
	<li class="first"> <a href="index.html"> Home </a> 
 	<li> <a href="../../../rutgers/index.html"> Rutgers </a> 
 	<li> <a href="../../index.html"> CS 416 </a> 
 	<li> <a href="../../notes/index.html"> Documents </a> 
 	<li> <a href="../../notes/c-tutorials/index.html"> Tutorials </a> 
 	<li> <a href="../../notes/c-tutorials/gettime.html"> High resolution clock Tutorial </a> 
</ul>
</div>
<div id="content-wrapper">
<div id="main">
<div id="headline">
<h1> C Tutorial: Use Linux's high resolution clock </h1>
</div>

<div class="box">
Note: The <em>clock_gettime</em> system call described here is not
supported by OS X. 
</div>

<h1> Clock_gettime </h1>
<p>
The <em>clock_gettime</em> system call is a successor to the <a href="times.html">gettimeofday</a> system
call with a few key changes: higher precision and the ability to request specific clocks.
It fills in a structure containing two fields: a seconds and a nanosecond count of the time 
since the Epoch (00:00 1 January, 1970 UTC). This is similar to the <code>struct timeval</code> that
<em>gettimeofday</em> used except that the microsecond field is now replaced with a nanosecond field.
</p>
<div class="codeblock">
struct timespec {
	time_t   tv_sec;        /* seconds */
	long     tv_nsec;       /* nanoseconds */
};
</div>

<p>
The <em>clock_gettime</em> system call has the following usage:
</p>
<div class="codeblock">
#include &lt;time.h&gt;

int clock_gettime(clockid_t clk_id, struct timespec *tp);
</div>

<p>
The second parameter is the time structure that will be filled in by the system call to contain
the value of the clock. The first parameter, clock ID,  allows you to specify the clock you are interested in using.
The following are available:
</p>
<table>
<tr> <th> clock ID </th> <th> meaning </th> </tr>
<tr> <td> CLOCK_REALTIME </td> <td> 
System-wide real-time clock. This clock is supported by all implementations and
returns the number of seconds and nanoseconds since the Epoch.
This clock can be set via <em>clock_settime</em> but doing so requires appropriate privileges.
When the system time is changed, timers that measure relative intervals are not affected
but timers for absolute point in times are.
</td></tr>

<tr> <td> CLOCK_REALTIME_COARSE  (Linux-specific) </td> <td> 
Faster than CLOCK_REALTIME but not as accurate.
</td></tr>

<tr> <td> CLOCK_MONOTONIC </td> <td> 
Represents monotonic time since some unspecified starting point.
This clock cannot be set.
</td></tr>

<tr> <td> CLOCK_MONOTONIC_RAW (Linux-specific) </td> <td> 
Similar to CLOCK_MONOTONIC, but provides access to a raw hardware-based time that is not subject to NTP adjustments.
</td></tr>

<tr> <td> CLOCK_MONOTONIC_COARSE  (Linux-specific) </td> <td> 
Like CLOCK_MONOTONIC but faster and not as accurate.
</td></tr>

<tr> <td> CLOCK_PROCESS_CPUTIME_ID </td> <td> 
High-resolution per-process timer from the CPU.
</td></tr>

<tr> <td> CLOCK_THREAD_CPUTIME_ID </td> <td> 
Thread-specific CPU-time clock.
</td></tr>
</table>

<p>
As with <em>gettimeofday</em>, the resolution depends on the implementation, so do not always expect to get nanosecond precision.
The <em>clock_getres</em> system call returns the resolution of the specified clock. This is
informational data since you do not need to apply any scaling factors to data returned by
<em>clock_gettime</em>: the values are in seconds and nanoseconds.

<div class="codeblock">
#include &lt;time.h&gt;

int clock_getres(clockid_t clk_id, struct timespec *res);
</div>

<p>
For example, if a clock's resolution is 1024 Hz (1/1,024 second), then the resulting resolution is
976562.5 nanoseconds, which will be reported by <em>clock_getres</em> as 976562.
</p>

<h2> Which clock to use </h2>
<p>
For getting the system's idea of the time of day (in seconds since the Epoch), one should use
<code>clock_gettime(CLOCK_REALTIME, &tp)</code>.
</p>
<p>
For measuring elapsed time, CLOCK_MONOTONIC is recommended. This clock will not necessarily
reflect the time of day but, unlike CLOCK_REALTIME, it is guaranteed to always be linearly
increasing (although not necessarily between reboots).
CLOCK_MONOTONIC is affected by adjustments caused by the 
Network Time Protocol (NTP) daemon. However, NTP adjustments will not cause this clock
to jump; it's rate might be adjusted to compensate for clock drift. CLOCK_REALTIME,
on the other hand, may leap forward or even backward after a time adjustment.
</p>
<p>
CLOCK_MONOTONIC_RAW is available only on some Linux kernels and the tick rate
will never be adjusted by NTP. This is fine for short programs but a clock drift
over longer periods of time may produce inaccurate results.
</p>
<p>
The CLOCK_PROCESS_CPU_TIME_ID clock measures <em>only</em> the CPU time consumed by
the process. If the kernel puts the process to sleep, the time it spends waiting
is not counted. If a process has multiple threads, CLOCK_THREAD_CPUTIME_ID
is similar but measures only the CPU time spent on the thread that is making the
request.
</p>

<h2> Example </h2>

<p>
To compile a program that uses <em>clock_gettime</em>, you need to link with <code>librt.a</code> (the real-time
library) by specifying <code>-lrt</code> on your compile line.
</p>
<p>
This example marks the start time by getting the value of CLOCK_MONOTONIC. The process then
sleeps for a second and marks the stop time by getting the value of CLOCK_MONOTONIC a second time.
It then does the same thing again but uses CLOCK_PROCESS_CPUTIME_ID. Since the CPU is not used
for the time that the process is sleeping, the results are substantially shorter.
</p>

<div class="codeblock-box"><span class="comment">/*
	gettime - get time via clock_gettime
	N.B.: OS X does not support clock_gettime

	Paul Krzyzanowski
*/</span>

#include &lt;stdio.h&gt;	<span class="comment">/* for printf */</span>
#include &lt;stdint.h&gt;	<span class="comment">/* for uint64 definition */</span>
#include &lt;stdlib.h&gt;	<span class="comment">/* for exit() definition */</span>
#include &lt;time.h&gt;	<span class="comment">/* for clock_gettime */</span>

#define BILLION 1000000000L

int localpid(void) {
	static int a[9] = { 0 };
	return a[0];
}

main(int argc, char **argv)
{
	uint64_t diff;
	struct timespec start, end;
	int i;

	<span class="comment">/* measure monotonic time */</span>
	clock_gettime(CLOCK_MONOTONIC, &amp;start);	<span class="comment">/* mark start time */</span>
	sleep(1);	<span class="comment">/* do stuff */</span>
	clock_gettime(CLOCK_MONOTONIC, &amp;end);	<span class="comment">/* mark the end time */</span>

	diff = BILLION * (end.tv_sec - start.tv_sec) + end.tv_nsec - start.tv_nsec;
	printf("elapsed time = %llu nanoseconds\n", (long long unsigned int) diff);

	<span class="comment">/* now re-do this and measure CPU time */</span>
	<span class="comment">/* the time spent sleeping will not count (but there is a bit of overhead */</span>
	clock_gettime(CLOCK_PROCESS_CPUTIME_ID, &amp;start);	<span class="comment">/* mark start time */</span>
	sleep(1);	<span class="comment">/* do stuff */</span>
	clock_gettime(CLOCK_PROCESS_CPUTIME_ID, &amp;end);		<span class="comment">/* mark the end time */</span>

	diff = BILLION * (end.tv_sec - start.tv_sec) + end.tv_nsec - start.tv_nsec;
	printf("elapsed process CPU time = %llu nanoseconds\n", (long long unsigned int) diff);

	exit(0);
}


</div>

<p>
<a href="files/gettime.c">Download this file</a>
</p>
<p>
Save this file by control-clicking or right clicking the download link and then saving it as <tt>gettime.c</tt>.
</p>
<p>
Compile this program via:
</p>
<div class="codeblock">
gcc -o gettime gettime.c -lrt
</div>
<p>
If you don't have gcc, You may need to substitute the gcc command with cc or another name of your compiler.
</p>
<p>
Run the program:
</p>
<div class="codeblock">
./gettime
</div>
</div>
<div id="footer">
<hr/>
<style type="text/css">  
span.codedirection { unicode-bidi:bidi-override; direction: rtl; }  
</style>  

<p> &copy; 2003-2019 Paul Krzyzanowski. All rights reserved.</p>
<p>For questions or comments about this site, contact Paul Krzyzanowski, 
<span class="codedirection">gro.kp@ofnibew</span>
</p>
<p>
The entire contents of this site are protected by copyright under national and international law.
No part of this site may be copied, reproduced, stored in a retrieval system, or transmitted, in any form,
or by any means whether electronic, mechanical or otherwise without the prior written
consent of the copyright holder.
If there is something on this page that you want to use, please let me know.
</p>
<p>
Any opinions expressed on this page do not necessarily reflect the opinions of my employers and may not
even reflect my own.
</p>
<p> Last updated: March 28, 2019
</p>
<img class="stamp" src="../../..//css/images/recycled_pixels_logo.png" alt="recycled pixels" height="80" width="80" />
</div> <!-- footer -->
<div id="tear">
</div>


<div id="sidebar1">
<h1 class="first">Contents </h1>
	<h2> CS 416 </h2>
	<ul>
	<li> <a href="../../index.html"> Main course page </a> </li>
	<li> <a href="../../news.html"> News </a> </li>
	<li> <a href="../../syllabus.html"> Syllabus </a> </li>
	<li> <a href="../../hw/index.html"> Homework </a> </li>
	<li> <a href="../../notes/index.html"> Documents </a> </li>
	<li> <a href="../../exam/index.html"> Exam info </a> </li>
	<li> <a href="../../grades/index.html"> Check your grades </a> </li>
	<li> <a href="https://sakai.rutgers.edu/portal"> Sakai </a> </li>
	</ul>

        <h2> Tutorials </h2>
        <ul>
        <li> <a href="../../notes/c-tutorials/index.html"> C/Unix tutorials </a> </li>
        <li> <a href="../../notes/make/index.html"> Makefile tutorial </a> </li>
        <li> <a href="../../notes/sockets/index.html"> TCP/IP Sockets </a> </li>
        <li> <a href="../../notes/rpc/index.html"> ONC RPC tutorial </a> </li>
<!--
        <li> <a href="../../notes/clocks/index.html"> Clocks demo </a> </li>
-->
        </ul>

	
        <h2> <a href="index.html">C Tutorials</a> </h2>
	<h3> Processes </h3>
        <ul>
        <li> <a href="../../notes/c-tutorials/getpid.html"> getpid </a> </li>
        <li> <a href="../../notes/c-tutorials/getppid.html"> getppid </a> </li>
        <li> <a href="../../notes/c-tutorials/fork.html"> fork </a> </li>
        <li> <a href="../../notes/c-tutorials/exec.html"> exec </a> </li>
        <li> <a href="../../notes/c-tutorials/forkexec.html"> fork&amp;exec </a> </li>
        <li> <a href="../../notes/c-tutorials/wait.html"> wait </a> </li>
        <li> <a href="../../notes/c-tutorials/signal.html"> signal </a> </li>
	</ul>
	<h3> I/O and IPC </h3>
	<ul>
        <li> <a href="../../notes/c-tutorials/dup2.html"> dup2 </a> </li>
        <li> <a href="../../notes/c-tutorials/pipe.html"> pipe and dup2 </a> </li>
        <li> <a href="../../notes/c-tutorials/isatty.html"> isatty </a> </li>
	<ul>
	</ul>
	<h3> Timing </h3>
        <li> <a href="../../notes/c-tutorials/times.html"> times </a> </li>
        <li> <a href="../../notes/c-tutorials/gettime.html"> clock_gettime </a> </li>
	<ul>
	<h3> Basics </h3>
	<ul>
        <li> <a href="../../notes/c-tutorials/getopt.html"> Command options </a> </li>
        <li> <a href="../../notes/c-tutorials/strtok.html"> Parsing tokens </a> </li>
<!--
        <li> <a href="../../notes/c-tutorials/fpointer.html"> Pointers to functions </a> </li>
-->
        <li> <a href="../../notes/c-tutorials/list.html"> Linked list </a> </li>
<!--
        <li> <a href="../../notes/c-tutorials/hash.html"> Hash tables </a> </li>
-->
        </ul>

</div>

<div id="sidebar2">
<h1 class="first"> Recommended </h1>
<p>
</p>
<p>
<a href="http://www.amazon.com/exec/obidos/ASIN/020161586X/pkorg/">
<img align="left" width="100" height="138" src="images/practice-of-programming.jpg"
alt="The Practice of Programming"/>
</a>
</p>
<p>
&nbsp;
</p>

<p>
<a href="http://www.amazon.com/exec/obidos/ASIN/0131103628/pkorg/">
<img align="left" width="100" height="132" src="images/c-programming-language.jpg"
alt="The C Programming Language"/>
</a>
</p>
<p>
&nbsp;
</p>

<p>
<a href="http://www.amazon.com/dp/013937681X/pkorg/">
<img align="left" width="100" height="132" src="images/unix-programming-environment.jpg"
alt="The UNIX Programming Environment"/>
</a>
</p>
</div>

</div>
</div>
</body>
</html>
