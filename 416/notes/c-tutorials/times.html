<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title> CS 416 Documents </title>
<link href="../../../css/layout.css" rel="stylesheet" type="text/css" />
<link href="../../../css/main.css" rel="stylesheet" type="text/css" />
<link href="../../../css/print.css" rel="stylesheet" type="text/css" media="print" />
<link href="../../../css/main-print.css" rel="stylesheet" type="text/css" media="print" />
<style type="text/css">

#main table.doclist {
	width: 80%;
}
#main .doclist .date, #main .doclist .item {
        vertical-align: baseline; /* for opera */
}
#main .doclist tr {
        vertical-align: baseline;
}
#main .doclist th.item {
        text-align: left;
}
#main .doclist td.item {
        text-align: left;
}
#main a.linksign:link, #main a.linksign:visited, #main a.linksign a:hover {
        text-decoration: none;
}

</style>
</head>
<body id="s_ru416">
<div id="wrapper">
<!-- _______________________________________ BANNER _______________________________________ -->
<div id="banner">
  <div id="logo">
  <img src="../../../css/images/pk-org-pencil.png" alt="pk.org" name="logo" width="122" height="45"/>
  </div>
  <div id="title"> Operating Systems </div>
  <div id="search">
  <form method="get" action="http://www.google.com/search">
	<div style="border:none ;padding:2px;width:25em;">
	<input type="text" name="q" size="25" maxlength="255" value="" />
	<input type="submit" value="Search" />
	<input type="hidden"  name="sitesearch" value="www.pk.org" checked />
	</div>
  </form>
  </div>
  <ul>
    <li class="separator"><a href="../../../about/index.html">About</a></li>
    <li class="separator"><a href="../../../about/contact.html">Contact</a></li>
    <li><a href="../../../sitemap.html">Site map</a></li>
  </ul>
</div>

<!-- _______________________________________ MAIN NAV _______________________________________ -->
<div id="navbar">
	<ul>
	<li class="homelink"><a href="../../../index.html">Home</a></li>
<!--
	<li class="aboutlink"><a href="../../../about/index.html">About</a></li>
-->
	<li class="ru"><a href="../../../rutgers/index.html">Rutgers</a></li>
	<li class="ru352"><a href="../../../352/index.html">Internet Technology [352]</a></li>
	<li class="ru416"><a href="../../../416/index.html">Operating Systems [416]</a></li>
	<li class="ru417"><a href="../../../417/index.html">Distributed Systems [417]</a></li>
	<li class="ru419"><a href="../../../419/index.html">Computer Security [419]</a></li>
	<li class="cslink"><a href="../../../cs/index.html">Computing</a></li>
	<li class="photolink"><a href="../../../photo/index.html">Photography</a></li>
<!--
	<li class="funlink"><a href="#">Coming</a></li>
	<li class="funlink"><a href="#">Soon</a></li>
-->
	</ul>
</div>

<div id="subnav">
<p>
You are in: 
</p>
<ul>
	<li class="first"> <a href="index.html"> Home </a> 
 	<li> <a href="../../../rutgers/index.html"> Rutgers </a> 
 	<li> <a href="../../index.html"> CS 416 </a> 
 	<li> <a href="../../notes/index.html"> Documents </a> 
 	<li> <a href="../../notes/c-tutorials/index.html"> Tutorials </a> 
 	<li> <a href="../../notes/c-tutorials/times.html"> Resource clock Tutorial </a> 
</ul>
</div>
<div id="content-wrapper">
<div id="main">
<div id="headline">
<h1> C Tutorial: Get and measure elapsed process time </h1>
</div>

<h1> times: get current process times </h1>
<p>
The <em>times</em> system call gets the user time and system time used by the current process and its children.
<strong>User time</strong> is the time that the processor spent executing instructions in the process.
<strong>System time</strong> is the time that the processor spent in the operating system executing instructions
on behalf of the process. The <em>times</em> system call has the following usage:
</p>
<div class="codeblock">
#include &lt;sys/times.h&gt;

clock_t times(struct tms *buf);
</div>
<p>
Prior to calling <em>times</em>, you'll need to declare a variable of <code>struct tms</code> that
the system call will fill in. The struct is defined in <code>sys/times.h</code> as:
<div class="codeblock">
struct tms {
	clock_t tms_utime;  /* user time */
	clock_t tms_stime;  /* system time */
	clock_t tms_cutime; /* user time of children */
	clock_t tms_cstime; /* system time of children */
};
</div>
<p>
Note that all values are in <code>clock_t</code> units. The actual definition of <code>clock_t</code> 
is system-dependent. It is typically a <code>long</code> but might be a <code>long long</code> on
some systems. All the time values are expressed in "clock ticks." This is an ever-incrementing count
of the operating system's "ticks". We can obtain the frequency of these ticks via the <em>sysconf</em>
function, which allows us to test and get various system configuration values at runtime. To find
the clock frequency, we use:
</p>
<div class="codeblock">
#include &lt;unistd.h&gt;

sysconf(_SC_CLK_TCK);
</div>
<p>
The call to <em>sysconf(_SC_CLK_TCK)</em> returns a <code>long</code> that indicates the number of ticks per second. Both
my Ubuntu Linux and OS X report a value of 100, which means that each tick represents a count of
1/100 second (0.01 s). 
</p>

<h2> Example: reading current process times  </h2>
<p>
This is a small program that does some busy work to use up a bit of CPU time and kernel
resources (in the <em>kill_time</em> function) and then prints the time value in clock ticks. 
Note that we cast the time values into type <code>uintmax_t</code> and call <em>printf</em>
with a format of <code>%j</code>. This type represents tha largest available integer. You
can usually get away with using <code>long</code> or <code>long long</code>.
</p>

<div class="codeblock-box"><span class="comment">/* times: report times used by the current process */</span>
<span class="comment">/* Paul Krzyzanowski */</span>

#include &lt;stdio.h&gt;		<span class="comment">/* defines printf() */</span>
#include &lt;stdlib.h&gt;		<span class="comment">/* to define exit() */</span>
#include &lt;unistd.h&gt;		<span class="comment">/* for sysconf() */</span>
#include &lt;stdint.h&gt;		<span class="comment">/* used for casting clock_t to uintmax_t for printf */</span>
#include &lt;sys/times.h&gt;		<span class="comment">/* needed for the times() system call */</span>
#include &lt;sys/types.h&gt;
#include &lt;sys/stat.h&gt;		<span class="comment">/* used for open() */</span>
#include &lt;fcntl.h&gt;		<span class="comment">/* used for open() */</span>

void kill_time(void);

int
main(int argc, char **argv) {
	struct tms t;	<span class="comment">/* the time values will be placed into this struct */</span>

	printf("tick frequency is: %lu\n", sysconf(_SC_CLK_TCK));

	kill_time();		<span class="comment">/* do something to use up some time */</span>
	if (times(&amp;t) &lt; 0) {
		perror("times");	<span class="comment">/* error - print a message and exit */</span>
		exit(1);
	}
	<span class="comment">/* print the results */</span>
	printf("user time: %ju ticks\n", (uintmax_t) t.tms_utime);
	printf("system time: %ju ticks\n", (uintmax_t) t.tms_stime);
	printf("chidren - user time: %ju ticks\n", (uintmax_t) t.tms_cutime);
	printf("chidren - system time: %ju ticks\n", (uintmax_t) t.tms_cstime);

	exit(0);
}

void
kill_time(void) {
	long long i, j;	<span class="comment">/* use these in a loop to kill time */</span>
	int fd;
	char buf[2048];

	printf("doing some cpu wasting stuff\n");
	for (i=0; i&lt;100000000; i++)
		j += i;

	printf("doing some kernel wasting stuff\n");
	<span class="comment">/* do some stuff to waste system time */</span>
	if ((fd = open("/dev/urandom", O_RDONLY)) &lt; 0) {
		perror("open");
		exit(1);
	}
	for (i=0; i &lt; 1000; i++) 
		read(fd, buf, 2048);
	close(fd);
}

</div>

<p>
<a href="files/times.c">Download this file</a>
</p>
<p>
Save this file by control-clicking or right clicking the download link and then saving it as <tt>times.c</tt>.
</p>
<p>
Compile this program via:
</p>
<div class="codeblock">
gcc -o times times.c
</div>
<p>
If you don't have gcc, You may need to substitute the gcc command with cc or another name of your compiler.
</p>
<p>
Run the program:
</p>
<div class="codeblock">
./times
</div>

<h1> Measure elapsed time between two points in your code </h1>

<p>
The <em>times</em> system call returns the current tick count.
This is an ever-incrementing number from some arbitrary point in the past.
While this on its own is not useful, we can use it to mark a starting and ending time. The difference between
these two times is the elapsed time. To do this, we don't care about the data placed in the <code>tms</code> struct.
Linux does reasonable error checking and allows us to call <em>times</em> with a null pointer as a parameter.
OS X, however, tries to write time values into a structure, which causes the program to die due to an
attempt to dereference a null pointer. It is safer to pass a <code>struct tms</code> pointer that
we will simply ignore.

</p>
<p>

<h2> Example: measuring elapsed time </h2>
<p>
In the last example, we ignored the return value from a call to <em>times</em>.
In this program, we ignore the <code>struct tms</code> parameter to <em>times</em> but record
a start time and a stop time. Between these two times, it calls <em>sleep(2)</em> to sleep for two
seconds. It then prints the result in ticks and in seconds. To convert ticks to seconds, you simply
divide the elapsed tick count by the frequency obtained from <em>sysconf(_SC_CLK_TCK)</em>.
</p>
<p>
Note that we ignore the case of the clock overflowing and wrapping back through 0 during our test.
Good programming would dictate that we take this into account.
In practice, the value of <code>clock_t</code> on my 64-bit processors (my Linux and Mac systems) is
an unsigned 64-bit integer with a clock frequency of 100 ticks per seconds. That corresponds to 
a clock wraparound period of 1.8&times;10<sup>17</sup> seconds or 5.8&times;10<sup>9</sup> years.
I'll take my chances that this will not happen. With 32 bit machines, you need to be more careful
since the wrap-around time with a 100 Hz clock will be under two years and far less with a higher
frequency clock. If you want to write portable code, you'll need to be aware that wrap-around
can be a very real possibility on some architectures.
</p>

<div class="codeblock-box"><span class="comment">/* times: use times() to get the elapsed time */</span>
<span class="comment">/* Paul Krzyzanowski */</span>

#include &lt;stdio.h&gt;		<span class="comment">/* declares printf() */</span>
#include &lt;stdlib.h&gt;		<span class="comment">/* declares exit() */</span>
#include &lt;unistd.h&gt;		<span class="comment">/* declares sysconf() */</span>
#include &lt;stdint.h&gt;		<span class="comment">/* used for casting clock_t to uintmax_t for printf */</span>
#include &lt;sys/times.h&gt;		<span class="comment">/* needed for the times() system call */</span>

int
main(int argc, char **argv) {
	struct tms t;		<span class="comment">/* parameter to times() - we'll ignore it */</span>
	unsigned long freq;	<span class="comment">/* clock frequency */</span>
	uintmax_t start;	<span class="comment">/* starting tick value */</span>
	uintmax_t end;		<span class="comment">/* ending tick value */</span>

	printf("sizeof(clock_t) = %lu\n", sizeof(clock_t));
	printf("tick frequency is: %lu\n", freq=sysconf(_SC_CLK_TCK));

	if ((start = times(&amp;t)) &lt; 0) {	<span class="comment">/* mark the start time */</span>
		perror("times");	<span class="comment">/* error - print a message and exit */</span>
		exit(1);
	}
	sleep(2);	<span class="comment">/* sleep for two seconds */</span>
	if ((end = times(&amp;t)) &lt; 0) {	<span class="comment">/* mark the end time */</span>
		perror("times");	<span class="comment">/* error - print a message and exit */</span>
		exit(1);
	}
	printf("elapsed time: %ju - %ju = %ju ticks\n", end, start, end-start);
	printf("elapsed time: %5.2f seconds\n", (double)(end-start)/freq);
	exit(0);
}

</div>

<p>
<a href="files/elapsed.c">Download this file</a>
</p>
<p>
Save this file by control-clicking or right clicking the download link and then saving it as <tt>elapsed.c</tt>.
</p>
<p>
Compile this program via:
</p>
<div class="codeblock">
gcc -o elapsed elapsed.c
</div>
<p>
If you don't have gcc, You may need to substitute the gcc command with cc or another name of your compiler.
</p>
<p>
Run the program:
</p>
<div class="codeblock">
./elapsed
</div>

<h1> The clock function </h1>
<p>
The <em>clock</em> library function (not system call) provides an analogous approach to
the return value of <em>times</em> to mark start and end times. <em>Clock</em> takes no parameter
and returns an estimate of the processor time used by the running process. The starting time value 
is undefined so you need to resort to reading the start and end times and then computing the
difference, just as we did with <em>times</em>.
</p>
<p>
The big difference between measuring with <em>clock</em> and <em>times</em> is that <em>clock</em>
measures approximate process time used while <em>times</em> returns overall elapsed time.
If you try the above program that sleeps for two seconds with <em>clock</em>, you will get a 
value of 0 elapsed seconds. Basically, the call to <em>sleep</em> put the process to sleep 
and there was no CPU time used on behalf of the process during that time.
<p>
While <em>clock</em> returns its result in the same <code>clock_t</code> data type as <em>times</em>,
the scale is different. The POSIX requires that the result be scaled by a value CLOCKS_PER_SEC, which
is always defined as one million (1000000), regardless of the actual clock resolution. Note that the
finer scale <strong>does not</strong> mean that <em>clock</em> will always produce more accurate results.
The accuracy depends on the implementation.
Also note that the high value of CLOCKS_PER_SEC will cause the clock to wrap around to 0 approximately
every 72 minutes on a 32-bit processor.
</p>

<div class="codeblock-box"><span class="comment">/* times: use clock() to get the elapsed time */</span>

#include &lt;stdio.h&gt;		<span class="comment">/* declares printf() */</span>
#include &lt;stdlib.h&gt;		<span class="comment">/* declares exit() */</span>
#include &lt;stdint.h&gt;		<span class="comment">/* used for casting clock_t to uintmax_t for printf */</span>
#include &lt;time.h&gt;		<span class="comment">/* needed for the clock() library function */</span>

int
main(int argc, char **argv) {
	unsigned long freq;	<span class="comment">/* clock frequency */</span>
	uintmax_t start;	<span class="comment">/* starting tick value */</span>
	uintmax_t end;		<span class="comment">/* ending tick value */</span>

	start = clock(); 	<span class="comment">/* mark the start time */</span>
	sleep(2);	<span class="comment">/* sleep for two seconds */</span>
	end = clock(); 		<span class="comment">/* mark the end time */</span>

	printf("elapsed time: %ju - %ju = %ju ticks\n", end, start, end-start);
	printf("elapsed time: %8.6f seconds\n", (double)(end-start)/CLOCKS_PER_SEC);
	exit(0);
}

</div>

<p>
<a href="files/clock.c">Download this file</a>
</p>
<p>
Save this file by control-clicking or right clicking the download link and then saving it as <tt>clock.c</tt>.
</p>
<p>
Compile this program via:
</p>
<div class="codeblock">
gcc -o clock clock.c
</div>
<p>
If you don't have gcc, You may need to substitute the gcc command with cc or another name of your compiler.
</p>
<p>
Run the program:
</p>
<div class="codeblock">
./clock
</div>


<h1> The gettimeofday system call </h1>
<p>
As if we didn't have enough mechanisms to compute time intervals, we can also use the
<em>gettimeofday</em> system call. It has the following usage:
</p>
<div class="codeblock">
#include &lt;sys/time.h&gt;

int gettimeofday(struct timeval *tv, struct timezone *tz);
</div>
<p>
This function, as its name implies, measures the time of day. It returns its value as the 
number of seconds and microseconds since the Epoch, which is defined as midnight (0:00) January 1, 1970 
UTC (Greenwich Mean Time). This value is returned in the first parameter, which is
a pointer to a structure that contains two fields: seconds and microseconds. The second parameter
identifies the time zone but this is obsolete and should not be used. Keeping track of elapsed seconds
avoids the problems of time jumps due to daylight saving time or timezone changes. Those can be 
added in if a printable calendar time is ever required (see the <em>ctime</em> function).
</p>
<p>
As with <em>clock</em>, note that the precision is limited by the kernel's timekeeping granularity.
Just because the data structure reads microseconds does not imply that you will get microsecond accuracy.
</p>
Here's an example of using <em>gettimeofday</em>. You'll note that we measure the overall delay.
Expect the delay to be greater than 2 seconds (2,000,000 microseconds) since we show a greater resolution
than we do with <em>times</em>.
</p>
<div class="codeblock-box"><span class="comment">/* times: use gettimeofday() to get the elapsed time */</span>
<span class="comment">/* Paul Krzyzanowski */</span>

#include &lt;stdio.h&gt;		<span class="comment">/* declares printf() */</span>
#include &lt;stdlib.h&gt;		<span class="comment">/* declares exit() */</span>
#include &lt;stdint.h&gt;		<span class="comment">/* used for casting clock_t to uintmax_t for printf */</span>
#include &lt;sys/time.h&gt;		<span class="comment">/* needed for the gettimeofday() system call */</span>

int
main(int argc, char **argv) {
	struct timeval start;	<span class="comment">/* starting time */</span>
	struct timeval end;	<span class="comment">/* ending time */</span>
	unsigned long e_usec;	<span class="comment">/* elapsed microseconds */</span>

	gettimeofday(&amp;start, 0);	<span class="comment">/* mark the start time */</span>
	sleep(2);		<span class="comment">/* sleep for 2 seconds */</span>
	gettimeofday(&amp;end, 0);		<span class="comment">/* mark the end time */</span>

	<span class="comment">/* now we can do the math. timeval has two elements: seconds and microseconds */</span>
	e_usec = ((end.tv_sec * 1000000) + end.tv_usec) - ((start.tv_sec * 1000000) + start.tv_usec);

	printf("elapsed time: %lu microseconds\n", e_usec);
	exit(0);
}

</div>

<p>
<a href="files/gettimeofday.c">Download this file</a>
</p>
<p>
Save this file by control-clicking or right clicking the download link and then saving it as <tt>gettimeofday.c</tt>.
</p>
<p>
Compile this program via:
</p>
<div class="codeblock">
gcc -o gettimeofday gettimeofday.c
</div>
<p>
If you don't have gcc, You may need to substitute the gcc command with cc or another name of your compiler.
</p>
<p>
Run the program:
</p>
<div class="codeblock">
./gettimeofday
</div>

<h1> Beware! </h1>
<p>
The problem with using a time-of-day report such as the <em>gettimeodday</em> system call is that
the time-of-day clock may be spontaneously adjusted to keep the system's time of day synchronized
with UTC time (for example, via the Network Time Protocol, NTP). Whenever the time is adjusted,
your measurement of the interval between start and stop times becomes invalid and, unless you notice something
bizarre such as an end time that is less than the start time, you will not even know that
an adjustment took place.
</p>
<p>
The <em>gettimeofday</em> system call is considered obsolete but is still supported on most POSIX
systems. The replacement is <em>clock_gettime</em> but it is not broadly supported yet (OS X, does not
have it as of February 2014, for example).
</p>
<p>
For high-resolution benchmarking,
the recommended approach, if available, is to use <a href="gettime.html">clock_gettime</a>.
</p>

</div>
<div id="footer">
<hr/>
<style type="text/css">  
span.codedirection { unicode-bidi:bidi-override; direction: rtl; }  
</style>  

<p> &copy; 2003-2019 Paul Krzyzanowski. All rights reserved.</p>
<p>For questions or comments about this site, contact Paul Krzyzanowski, 
<span class="codedirection">gro.kp@ofnibew</span>
</p>
<p>
The entire contents of this site are protected by copyright under national and international law.
No part of this site may be copied, reproduced, stored in a retrieval system, or transmitted, in any form,
or by any means whether electronic, mechanical or otherwise without the prior written
consent of the copyright holder.
If there is something on this page that you want to use, please let me know.
</p>
<p>
Any opinions expressed on this page do not necessarily reflect the opinions of my employers and may not
even reflect my own.
</p>
<p> Last updated: March 28, 2019
</p>
<img class="stamp" src="../../..//css/images/recycled_pixels_logo.png" alt="recycled pixels" height="80" width="80" />
</div> <!-- footer -->
<div id="tear">
</div>


<div id="sidebar1">
<h1 class="first">Contents </h1>
	<h2> CS 416 </h2>
	<ul>
	<li> <a href="../../index.html"> Main course page </a> </li>
	<li> <a href="../../news.html"> News </a> </li>
	<li> <a href="../../syllabus.html"> Syllabus </a> </li>
	<li> <a href="../../hw/index.html"> Homework </a> </li>
	<li> <a href="../../notes/index.html"> Documents </a> </li>
	<li> <a href="../../exam/index.html"> Exam info </a> </li>
	<li> <a href="../../grades/index.html"> Check your grades </a> </li>
	<li> <a href="https://sakai.rutgers.edu/portal"> Sakai </a> </li>
	</ul>

        <h2> Tutorials </h2>
        <ul>
        <li> <a href="../../notes/c-tutorials/index.html"> C/Unix tutorials </a> </li>
        <li> <a href="../../notes/make/index.html"> Makefile tutorial </a> </li>
        <li> <a href="../../notes/sockets/index.html"> TCP/IP Sockets </a> </li>
        <li> <a href="../../notes/rpc/index.html"> ONC RPC tutorial </a> </li>
<!--
        <li> <a href="../../notes/clocks/index.html"> Clocks demo </a> </li>
-->
        </ul>

	
        <h2> <a href="index.html">C Tutorials</a> </h2>
	<h3> Processes </h3>
        <ul>
        <li> <a href="../../notes/c-tutorials/getpid.html"> getpid </a> </li>
        <li> <a href="../../notes/c-tutorials/getppid.html"> getppid </a> </li>
        <li> <a href="../../notes/c-tutorials/fork.html"> fork </a> </li>
        <li> <a href="../../notes/c-tutorials/exec.html"> exec </a> </li>
        <li> <a href="../../notes/c-tutorials/forkexec.html"> fork&amp;exec </a> </li>
        <li> <a href="../../notes/c-tutorials/wait.html"> wait </a> </li>
        <li> <a href="../../notes/c-tutorials/signal.html"> signal </a> </li>
	</ul>
	<h3> I/O and IPC </h3>
	<ul>
        <li> <a href="../../notes/c-tutorials/dup2.html"> dup2 </a> </li>
        <li> <a href="../../notes/c-tutorials/pipe.html"> pipe and dup2 </a> </li>
        <li> <a href="../../notes/c-tutorials/isatty.html"> isatty </a> </li>
	<ul>
	</ul>
	<h3> Timing </h3>
        <li> <a href="../../notes/c-tutorials/times.html"> times </a> </li>
        <li> <a href="../../notes/c-tutorials/gettime.html"> clock_gettime </a> </li>
	<ul>
	<h3> Basics </h3>
	<ul>
        <li> <a href="../../notes/c-tutorials/getopt.html"> Command options </a> </li>
        <li> <a href="../../notes/c-tutorials/strtok.html"> Parsing tokens </a> </li>
<!--
        <li> <a href="../../notes/c-tutorials/fpointer.html"> Pointers to functions </a> </li>
-->
        <li> <a href="../../notes/c-tutorials/list.html"> Linked list </a> </li>
<!--
        <li> <a href="../../notes/c-tutorials/hash.html"> Hash tables </a> </li>
-->
        </ul>

</div>

<div id="sidebar2">
<h1 class="first"> Recommended </h1>
<p>
</p>
<p>
<a href="http://www.amazon.com/exec/obidos/ASIN/020161586X/pkorg/">
<img align="left" width="100" height="138" src="images/practice-of-programming.jpg"
alt="The Practice of Programming"/>
</a>
</p>
<p>
&nbsp;
</p>

<p>
<a href="http://www.amazon.com/exec/obidos/ASIN/0131103628/pkorg/">
<img align="left" width="100" height="132" src="images/c-programming-language.jpg"
alt="The C Programming Language"/>
</a>
</p>
<p>
&nbsp;
</p>

<p>
<a href="http://www.amazon.com/dp/013937681X/pkorg/">
<img align="left" width="100" height="132" src="images/unix-programming-environment.jpg"
alt="The UNIX Programming Environment"/>
</a>
</p>
</div>

</div>
</div>
</body>
</html>
